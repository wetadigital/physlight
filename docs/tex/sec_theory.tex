% SPDX-License-Identifier: Apache-2.0
% Copyright (c) Contributors to the PhysLight Project.

%%% Some of this material went into sec_appendix,
%%% Not sure what happened to the rest

\chapter{Illuminants}\label{sec:theory}

\section{Spectral Distribution Functions}

\subsection{Black body radiator}

\begin{figure}
{
\small
\centering
\input{figures/blackbody.pgf}
\caption{Spectral distributions of black body radiator at various temperatures}
\label{fig:blackbody}
}
\vskip 1mm
{\footnotesize\it Plots of spectral distribution of black body
radiator at temperatures of $2855.54$, $3200$, $4500$, $5000$,
$5500$, $6500$, $7500$ degrees Kelvin.
In the rendition, the color of each curve is taken from the
sRGB coordinates for the corresponding color,
normalized so that the maximum sRGB linear value is $0.7$}
\end{figure}

Black body spectral radiance as per Planck's law~\cite{planck14}:
\begin{equation}
B_T(\lambda) = \frac{2 h c^2}{\lambda^5} \frac 1{e^{\frac{hc}{\lambda k
T}}-1}
\qquad \left[\unit{\watt\per\square\meter\per\steradian\per\meter}\right]
\end{equation}
where relevant constants and variables are:

\begin{center}
\begin{tabular}{c l l}
$k$                & Boltzmann constant        & \num{1.3806488e-23}\unit{\joule\per\kelvin}  \\
$h$                & Planck constant           & \num{6.62606957e-34}\unit{\joule\second}  \\
$c$                & speed of light in vacuum  & \num{2.99792458e8}\unit{\meter\per\second} \\
$T$                & temperature in kelvin     & $[\unit{\kelvin}]$    \\
$\lambda$          & wavelength in meter       & $[\unit{\meter}]$    \\
$T_{kK}$           & temperature in kilokelvin & $[\unit{\kilo\kelvin}]$ \\
$\lambda_{\mu m}$  & wavelength in micrometers & $[\unit{\micro\meter}]$ \\
\end{tabular}
\end{center}

Substitute values in, and rescale for numerical accuracy:

\begin{equation}
B_T(\lambda) = \frac{119.104}{\lambda_{\mu m}^5} \frac
1{e^{\frac{14.3878}{\lambda_{\mu m} T_{kK}}}-1}
\qquad \left[\unit{\watt\per\square\meter\per\steradian\per\meter}\right]
\end{equation}

\paragraph{Chromaticity}

\begin{figure}
{
\centering
\begin{minipage}{.4\textwidth}
\input{figures/chromas.pgf}
\end{minipage}
\begin{minipage}{.4\textwidth}
\input{figures/chromas_enlarge.pgf}
\end{minipage}

\caption{Comparison of CCTs for black body and Illuminant D}
\label{fig:blackbodychroma}
}
\vskip 1mm
{\footnotesize\it Red crosses show actual chromaticity for a black body
emitter, green crosses show the result from the approximation in
\cite{kang02}, blue crosses show the chromaticity of CIE Standard
Illuminant D. The plot on the right is an enlargement of the
central region of the plot on the left, the triangle in the left plot
is the sRGB gamut}
\end{figure}

White point for black body radiator. Black body's approximate chromaticity
coordinates in CIE $xy$ space can be computed following \cite{kang02} as:

\begin{equation}
\begin{array}{l}
w = 1/T_{kK} \qquad \text{inverse of temperature in kiloKelvin} \\[1mm]
x = \begin{cases}
     - .2991239\,w^3 -  .234358 \,w^2  +  .8776956\,w  + .17991 & T_{kK} \in [1.667, 4] \\
     -3.0258469\,w^3 + 2.1070379\,w^2  +  .2226347\,w  + .240390 & T_{kK} \in [4, 25]
    \end{cases} \\[1mm]
y = \begin{cases}
     -1.1063814\,x^3 - 1.34811020\,x^2 + 2.18555832\,x - .20219683 & T_{kK} \in [1.667, 2.222] \\
     - .9549476\,x^3 - 1.37418593\,x^2 + 2.09137015\,x - .16748867 & T_{kK} \in [2.222, 4] \\
      3.081758 \,x^3 - 5.8733867 \,x^2 + 3.75112997\,x - .37001483 & T_{kK} \in [4, 25]
    \end{cases} 
\end{array}
\end{equation}

\paragraph{Luminance}

Luminance of blackbody radiator $\|B_T\|_{\bar y} = \int B_T(\lambda)\bar y(\lambda) d\lambda$,
this can be approximately computed as

\begin{equation}
\|B_T\|_{\bar y} = \frac{\num{50471.2}}{e^{\frac{14.3878}{\num{0.0384919} +
\num{0.541533} T_{kK}}}-1}
\quad \left\{\begin{array}{cl}
\pm 0.375\% & T_{kK} \in [1.6, 2.5] \\
+0.23\% \pm 0.1\% & T_{kK} \in [2.5, 3.3] \\
\pm 0.155\% & T_{kK} \in [3.3, 8.5] \\
\pm 0.11\%  & T_{kK} \in [9, 25] \\
\end{array}\right.
\quad \left[\unit{\watt\per\square\meter\per\steradian}\right]
\end{equation}

\subsection{CIE Standard Illuminants}

A standard illuminant is a theoretical source of visible light with a profile
(its spectral
power distribution) which is published. Standard illuminants provide a basis for
comparing
images or colors recorded under different lighting. Standard Illuminants A, B,
and C were
introduced in 1931, with the intention of respectively representing average
incandescent light,
direct sunlight, and average daylight. Illuminants D represent phases of
daylight, Illuminant E
is the equal-energy illuminant, while Illuminants F represent fluorescent lamps
of various
composition, data for these illuminants is available in \cite{stdilluminants}.

\begin{figure}
{
\small
\centering
\input{figures/commonilluminants.pgf}
\caption{Spectral distributions of common Standard Illuminants}
\label{fig:illumspectra}
}
\vskip 1mm
{\footnotesize\it Plots of spectral distribution of
Standard Illuminants $A$, $D_{50}$, $D_{55}$, $D_{65}$, $D_{75}$,
normalized to equal luminance.
In the rendition, the color of each curve is taken from the
sRGB coordinates for the corresponding color,
normalized so that the maximum sRGB linear value is $0.7$.
The CIE color matching function $\bar y (\lambda)$ is also plotted in
black dashed line for reference}
\end{figure}

\paragraph{Standard Illuminant A}

The standard illuminant A defined by the \gls{CIE} is intended to
represent typical, domestic, tungsten-filament lighting.
Its relative spectral power distribution is that of a black body radiator at a
temperature of approximately \num{2855.54}\unit{\kelvin}.
Standard illuminant A should be used in all applications of colorimetry
involving the use of incandescent lighting, unless there are specific reasons
for
using a different illuminant. Using our previous expression for black body radiation we have
\begin{equation}
S_{A}(\lambda_{\mu m}) = B_{2855.54}(\lambda_{\mu m}) =
\frac{119.104}{\lambda_{\mu m}^5} \frac 1{e^{\frac{5.03855}{\lambda_{\mu m}}}-1}
\qquad \left[\unit{\watt\per\square\meter\per\steradian\per\meter}\right]
\end{equation}
where $\lambda_{\mu m}$ is the wavelength in micrometer.

\paragraph{Standard Illuminant D series}

The D series of illuminants were derived by Judd, MacAdam, and Wyszecki, from a
large number of measurements of natural daylight. Although they are rather
difficult sources to build accurately in real life, they are based on a simple
PCA decomposition of the data gathered during the measurements, making them
very convenient to work with numerically.

The spectral distribution $S_D(\lambda, T)$ is defined in terms of three tabulated spectral
distributions $S_0(\lambda)$, $S_1(\lambda)$ and $S_2(\lambda)$ (data is tabulated
and plotted in the appendix):
\begin{equation}
S_D(\lambda, T) = S_0(\lambda) + M_1(T) S_1(\lambda) + M_2(T) S_2(\lambda)
\end{equation}
where the weighting functions $M_1(T)$ and $M_2(T)$ are defined in terms of the
\gls{CIE} chromaticity coordinates $x_D, y_D$ as follows:
\begin{align*}
M   &= 0.0241 + 0.2562 x_D - 0.7341 y_D \\
M_1 &= \frac{-1.3515 - 1.7703 x_D + 5.9114 y_D}{M} \\
M_2 &= \frac{0.03 - 31.4424 x_D + 30.0717 y_D}{M} \\
\end{align*}

Due to changes in constants that have happened since 1931, Standard Illuminant $D_{65}$
corresponds to a temperature of \num{6504}\unit{\kelvin} and Standard Illuminant $D_{50}$
to a temperature of \num{5003}\unit{\kelvin}.

\paragraph{Chromaticity}
For D-series standard illuminants, \gls{CIE} xy coordinates are:

\begin{equation}
\begin{array}{rcl}
w & = & 1/T_{kK} \qquad \text{inverse of temperature in kiloKelvin}  \\
x & = & \begin{cases}
         - 4.6070\,w^3 + 2.9678 \,w^2 + .09911\,w + .244063  & T_{kK} \in [4, 7] \\
         - 2.0064\,w^3 + 1.9018\,w^2  +  .24748\,w + .237040 & T_{kK} \in [7, 25]
    \end{cases} \\
y & = & -3\,x^2  + 2.87\,x - .275
\end{array}
\end{equation}


\paragraph{Standard Illuminant E}

Standard Illuminant E is simply $S_E(\lambda) = 1$, an equal energy radiator

\paragraph{Standard Illuminant F series}

\begin{figure}
\small
\centering
\input{figures/illuminantf1-6.pgf}
\caption{Spectral distributions of CIE Standard Fluorescent Illuminants}
\label{fig:illumfspectrastd}
\vskip 1mm
{\footnotesize\it Plots of spectral distribution of
Standard Illuminants $F_1$ to $F_6$, standard spectra.
In the rendition, the color of each curve is taken from the
sRGB coordinates for the corresponding color,
normalized so that the maximum sRGB linear value is $0.85$.
}
\end{figure}

\begin{figure}
{
\small
\centering
\input{figures/illuminantf7-9.pgf}
\caption{Spectral distributions of CIE Broadband Fluorescent Illuminants}
\label{fig:illumfspectrabroad}
}
\vskip 1mm
{\footnotesize\it Plots of spectral distribution of
Standard Illuminants $F_7$ to $F_9$, broadband spectra.
In the rendition, the color of each curve is taken from the
sRGB coordinates for the corresponding color,
normalized so that the maximum sRGB linear value is $0.85$.
}
\end{figure}

\begin{figure}
{
\small
\centering
\input{figures/illuminantf10-12.pgf}
\caption{Spectral distributions of CIE Narrowband Fluorescent Illuminants}
\label{fig:illumfspectranarrow}
}
\vskip 1mm
{\footnotesize\it Plots of spectral distribution of
Standard Illuminants $F_{10}$ to $F_{12}$, narrowband spectra.
In the rendition, the color of each curve is taken from the
sRGB coordinates for the corresponding color,
normalized so that the maximum sRGB linear value is $0.85$.
}
\end{figure}

The F series of standard illuminants represent various types of fluorescent lighting.
$F_1$--$F_6$ ``standard'' fluorescent lamps consist of two semi-broadband
emissions of
antimony and manganese activations in calcium halophosphate phosphor, these are
plotted in \cref{fig:illumfspectrastd}. $F_4$ is of
particular interest since it was used for calibrating the \gls{CIE} \gls{CRI}
(the \gls{CRI} formula was chosen such that $F_4$ would have a \gls{CRI} of
$51$).
$F_7$--$F_9$ are ``broadband'' (full-spectrum light) fluorescent lamps with
multiple phosphors, and higher \glspl{CRI}, plotted in
\cref{fig:illumfspectrabroad}. Finally, $F_{10}$--$F_{12}$ are narrow
triband illuminants consisting of three ``narrowband'' emissions (caused by
ternary
compositions of rare-earth phosphors) in the R,G,B regions of the visible
spectrum, plotted in \cref{fig:illumfspectranarrow}.
The phosphor weights can be tuned to achieve the desired \gls{CCT}.
The spectra of these illuminants are published in \cite{ciecolorimetry}.

\ifomit
\subsection{ISO Sensitivity}

\begin{equation}
\frac{N^2}t = \frac{ES}{C}
\end{equation}

Reference: \link{http://en.wikipedia.org/wiki/Light_meter}
Reference: \link{http://en.wikipedia.org/wiki/F}

\subsection{Counting photons}

From the Planck relation we can compute the energy in a photon:

\begin{equation}
E = \frac{hc}{\lambda} \simeq \frac{1.98645}{\lambda_{\mu m}}\cdot 10^{-19} \;\unit{\joule} \in [2.5, 6]\cdot 10^{-19} \;\unit{\joule} \text{~for visible light}
\end{equation}

Reference: \link{http://en.wikipedia.org/wiki/Planck_constant}

\subsection{Digital sensors}
A digital sensor is made of electron wells, the well is able to absorb photons
and keep a count, with a given efficiency (40-50\% typical), and can count
absorptions in the mid-10kâ€™s (40k to 80k typical).
This means one well contains the equivalent of about \num{4e-14}\unit{\joule}
($O(10^5)$ photons of \num{4e-19}\unit{\joule} each).

Reference: \link{http://www.clarkvision.com/articles/digital.sensor.performance.summary/}

Example:
An isotropic source radiating \num{1}\unit{\watt} at \num{555}\unit{\nano\meter}
(which is a monocromatic source of \num{683}\unit{\lumen}) emits \num{2.793e18} photons per second.
At \num{1}\unit{\meter} distance from a Canon 7D sensor
(\num{22.3 x 14.9}\unit{\milli\meter}, \num{5184 x 3456}\unit{\pixel}, well size \num{4.3 x 4.3}\unit{\micro\meter}),
the well area is \num{18.5}\unit{\square\micro\meter}, whereas the total area the
source is radiating onto
is \num{4\pi}\unit{\square\meter} which is \num{1.475e-12} of the total area, meaning
the pixel would
receive \num{1.893e6} photons per second or about \num{31550} photons at ET
$\num{1/60}\unit{\second}$, if the
camera had infinitely wide aperture, and the lens absorbed no light and had
no focusing effect.

\subsubsection{Adding a lens}
Let's now say that the same source is imaged onto a single pixel through a lens
of
focal length $f = \num{24}\unit{\milli\meter}$, set at aperture $f/8$ and ET $t = \num{1/60}\unit{\second}$.

The aperture area is \num{2.25 \pi}\unit{\square\milli\meter} (the diameter of the
aperture is
$24/8 = \num{3}\unit{\milli\meter}$), so that the aperture is \num{0.625e-6} of the
total area, meaning
the pixel would receive \num{1.746e12} photons per second or about
\num{2.909e10} photons
at ET $\num{1/60}\unit{\second}$ (assuming no lens absorption).
\fi


\subsection{Color matching functions}

\begin{figure}
{
\centering
\input{figures/ciexyz1931.pgf}
\caption{Comparison of color matching functions from Wyman vs. CIE data}
\label{fig:cmf1931wyman}
}
\vskip 1mm
{\footnotesize\it Data from CIE 1931 is plotted with crosses,
the functions from  \cite{wyman13} are plotted with solid lines.

The three functions are $\bar x(\lambda)$ in red, $\bar y(\lambda)$ in green,
$\bar z(\lambda)$ in blue}
\end{figure}

In his recent paper \cite{wyman13}, Chris Wyman has proposed a simple
and fairly accurate analytical fitting for the color matching
functions (CIE 1931/1964, 2 deg/10 deg observers). For the 2 degree
observer these are:

\begin{equation}
\left.\begin{array}{r@{\,}l}
x_1(\lambda) &= (\lambda-442)   \cdot (0.0624 \diamond 0.0374) \\
x_2(\lambda) &= (\lambda-599.8) \cdot (0.0264 \diamond 0.0323) \\
x_3(\lambda) &= (\lambda-501.1) \cdot (0.049  \diamond 0.0382) \\
\end{array}\right\}\quad
\overline{x}(\lambda) =
  0.362\,G\big(x_1(\lambda)\big)
+ 1.056\,G\big(x_2(\lambda)\big)
- 0.065\,G\big(x_3(\lambda)\big)
\end{equation}

\begin{equation}
\left.\begin{array}{r@{\,}l}
y_1(\lambda) &= (\lambda-568.8) \cdot (0.0213 \diamond 0.0247) \\
y_2(\lambda) &= (\lambda-530.9) \cdot (0.0613 \diamond 0.0322) \\
\end{array}\right\}\quad
\overline{y}(\lambda) =
   0.821\,G\big(y_1(\lambda)\big)
 + 0.286 \,G\big(y_2(\lambda)\big)
\end{equation}
\begin{equation}
\left.\begin{array}{r@{\,}l}
z_1(\lambda) &= (\lambda-437) \cdot (0.0845 \diamond 0.0278) \\
z_2(\lambda) &= (\lambda-459) \cdot (0.0385 \diamond 0.0725) \\
\end{array}\right\}\quad
\overline{z}(\lambda) =
   1.217\,G\big(z_1(\lambda)\big)
 + 0.681 \,G\big(z_2(\lambda)\big)
\end{equation}
In the expressions above the function $G(x)$ is a gaussian
\begin{equation}
G(x) = e^{-\frac{x^2}{2}}
\end{equation}
and the $\diamond$ operator behaves as follows
\begin{equation}
a \cdot (b \diamond c) =
\begin{cases}
ab & a < 0 \\
ac & a \geq 0
\end{cases}
\end{equation}

The data for the three tabulated spectral curves $\bar x(\lambda)$, $\bar
y(\lambda)$, $\bar z(\lambda)$ as distributed by CIE is in
\cref{sec:cmfsdata}, \cref{tab:cmf1931},
page~\pageref{tab:cmf1931}.

\section{Spectral basis representation}
\label{sec:spec_basis}

In contrast to traditional RGB renderers, many contemporary renderers implement 
spectral light transport: they represent color values as functions of wavelength
internally, instead of relying purely on tristimulus values.
This allows effects such
as dispersion at dielectric boundaries to be reproduced with much higher fidelity.

Since input data is often provided to the renderer in some \gls{RGB} space,
a spectral lifting procedure is required. Such a procedure takes
tristimulus color values as an input and produces a spectrum that
corresponds to the same color.

The conversion from a spectrum $S(\lambda)$ to tristimulus values 
$(X, Y, Z)$ amounts to a projection onto a basis $(\bar x, \bar y, \bar z)(\lambda)$:
\begin{equation}
    \begin{pmatrix}X\\Y\\Z\end{pmatrix}
        = \int_\Lambda S(\lambda)\; 
    \begin{pmatrix}
        \bar x(\lambda)\\
        \bar y(\lambda)\\
        \bar z(\lambda)
    \end{pmatrix}
    \d\lambda
    \label{eqn:color_matching}
\end{equation}
While this operation is unique in the sense that there exists exactly one
value $(X,Y,Z)$ for any given spectrum $S(\lambda)$ and any particular basis
$(\bar x,\bar y, \bar z)$, the inverse operation is not. This phenomenon is called
\emph{metamerism}: spectra that are metameric to each other correspond to the
same tristimulus color value with respect to the given basis.

As a simple example, consider the family of box spectra
\begin{equation*}
    S_i(\lambda) = \begin{cases}
        i / 200, &\lambda \in [ (500-100/i)\unit{\nano\meter}, (500+100/i)\unit{\nano\meter}],\\
        0, &\text{otherwise}
    \end{cases}
\end{equation*}
for $i \geq 1 $ and the sensitivity function
\begin{equation*}
    \bar x(\lambda) = 1.
\end{equation*}
There are infinitely many such $S_i$, but for each of them,
\begin{equation*}
    \int_{380\unit{\nano\meter}}^{780\unit{\nano\meter}} S_i(\lambda) \bar x(\lambda)\d\lambda
    = 
    \int_{(500-100/i)\unit{\nano\meter}}^{(500+100/i)\unit{\nano\meter}} S(\lambda)\d\lambda
    = \frac{i}{200} \cdot \frac{200}{i} = 1,
\end{equation*}
and so these spectra are metamers with respect to $\bar x$.

This ambiguity is the main problem that needs to be solved in spectral
lifting procedures: out of the infinitely many spectra that, in general,
correspond to any given tristimulus value, one needs to be selected.

S selection criterion can be spectrum smoothness, because naturally occuring
reflectance spectra are generally smooth functions of wavelength~\citep{maloney86}. 
The widely
used technique by~\citet{smits99} therefore attempts to find spectra that
maximize a specific smoothness criterion in an expensive precomputation.
The precomputation is run for seven colors: the sRGB primaries 
Red$(\lambda)$, Green$(\lambda)$, and Blue$(\lambda)$, 
their complements
Cyan$(\lambda)$, Magenta$(\lambda)$, and Yellow$(\lambda)$, and White$(\lambda)$. 
Smits uses a run-time interpolation scheme
that, for any given input color, attempts to use as much as possible 
of the smoothest available spectrum by first mixing in the white spectrum, 
then one of the complement color spectra, and only then a primary spectrum.
We reproduce an implementation of this method in \cref{sec:implementation:texturemaps}.

Smits' technique is bound to the sRGB color space, and the sparse sampling with only
seven precomputed spectra can lead to poor results if a wider-gamut color space is
used, instead~\citep{meng2015}.

\citet{meng2015} generalize the method using a much denser sampling of the xy chromaticity
space, decoupling the spectral lifting method from the input color space.

Other authors have argued that a simple smoothness criterion can be problematic
in scenes with dominant indirect illumination: 
General smoothness simply ensures that the spectrum
will be reasonably well-behaved under reflection as even narrow-band incident lighting is
reflected by a wide-band reflectance spectrum. However, in the presence of multiple
reflections, intricate color shifts may occur in natural materials.
\citet{otsu2017} therefore attempt to extract, for any given input color, a metameric spectrum 
a principle component analysis on measured spectral reflectance data.

This approach might benefit from domain-specific measured data sets: For example, there might
be a set of measured spectra for leaves that is used whenever the appearance of leaves
is supposed to be recreated.

% Naturally other means of injecting spectral data in the renderer are possible,
% such as interpreting a texture as points in a
% low-dimensional linear subspace of the space of spectral distribution, such as a PCA
% decomposition of some space of reflectances. The basis could be passed to the
% renderer both via the header of the texture itself, or some other appropriate mean.
% The linearity of the subspace would mean that the normal machinery for texture
% filtering and mipmapping would be applicable without change to such textures of coefficients.


\section{Angular distributions}\label{sec:angular_norm}

\subsection{Powered cosine}

The angular norm $\|D\|$ of $\langle \omega, \hat n \rangle^n$ is
\begin{equation}
\|D(\omega)\|
   = \int_{\Omega^+} \langle \omega, \hat n \rangle \cos\theta \d\omega
   = \int_{\phi = 0}^{2\pi} \int_{\theta = 0}^{\pi/2} \cos^n\theta \cos\theta
     \sin\theta \d\theta \d\phi
   = 2\pi \left.\frac{-\cos^{n+2}\theta}{n+2}\right|_0^{\pi/2}
   = \frac{2\pi}{n+2}
\end{equation}

\subsection{IES profiles}

The \gls{IES} has a standard file format called \texttt{LM-63} (available in
three revisions \texttt{LM-63-1986}, \texttt{LM-63-1991} and
\texttt{LM-63-1995}) for photometric data describing luminaires. These files
are often called \gls{IES} profiles and are freely available from most
manufacturers. For the purposes of this document, an \gls{IES} profile
is simply an (unnormalized) intensity distribution map $D(\omega) =
D_{IES}(\theta,\phi)$, intended to be a bilinear interpolation of the data in
the corresponding tabulation from the file. As such it can simply be integrated
numerically evaluating the angular norm integral
\begin{equation}
\|D(\omega)\|
   = \int_{\Omega^+}  D_{IES}(\theta,\phi) \cos\theta \d\omega
   = \int_{\phi = 0}^{2\pi} \int_{\theta = 0}^{\pi/2}
        D_{IES}(\theta,\phi) \cos\theta \sin\theta \d\theta \d\phi
\end{equation}
implementation details are in \cref{sec:implementation}.

\section{Tint functions}

\subsection{Texture maps}
Explain texture maps, their primaries, how to use custom primaries.
Explain differences between textured emitters and transmittance/reflectance data


\subsection{Tabulated spectral data}
Sometimes tabulated data is available for various gels or filters, \cref{fig:roscolux}
includes plots of a subset of Rosco's \emph{RoscoLux} series of gels.

\begin{figure}
{
\centering
\includegraphics{figures/roscolux.pdf}
\caption{Spectral transmittance of \emph{RoscoLux} gel series}
\label{fig:roscolux}
}
\vskip 1mm
{\footnotesize\it Transmittance of the \emph{RoscoLux} series of gels from
Rosco. The coloration of the curve is the color of the gel as seen in front
of a D65 illuminant}
\end{figure}

